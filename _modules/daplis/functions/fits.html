

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>daplis.functions.fits &mdash; Data Analysis Package for LinoSPAD2 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Data Analysis Package for LinoSPAD2
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation and dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../daplis.html">daplis functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License and contact info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acknowledgement.html">Acknowledgement</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Data Analysis Package for LinoSPAD2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">daplis.functions.fits</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for daplis.functions.fits</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module for fitting timestamp differences with Gaussian function.</span>

<span class="sd">This file can also be imported as a module and contains the following</span>
<span class="sd">functions:</span>

<span class="sd">    * fit_with_gaussian - fit timestamp differences of a pair of pixels</span>
<span class="sd">    with a Gaussian function and plot a histogram of timestamp</span>
<span class="sd">    differences and the fit in a single figure.</span>

<span class="sd">    * fit_with_gaussian_combine - combine timestamp differences for the</span>
<span class="sd">    requested pixels before fitting them with a Gaussian function. Then,</span>
<span class="sd">    plot a histogram together with the fit.</span>

<span class="sd">    * fit_with_gaussian_all - find all peaks above the given threshold</span>
<span class="sd">    and fit them individually with a Gaussian function.</span>

<span class="sd">    * fit_with_gaussian_full_sensor - fit timestamp differences of a</span>
<span class="sd">    pair of pixels (one from each half of the sensor) with a Gaussian</span>
<span class="sd">    function and plot a histogram of timestamp differences and the fit</span>
<span class="sd">    in a single figure.</span>

<span class="sd">    * fit_with_gaussian_fancy - fit timestamp diferences of a pair of</span>
<span class="sd">    pixels using the lmfit library. The main parameters reported are</span>
<span class="sd">    the standard deviation, mean value, and contrast, together with</span>
<span class="sd">    residuals and signal-to-noise ratio (SNR) defined as a ratio of peak</span>
<span class="sd">    height to standard deviation of background.</span>

<span class="sd">    * unpickle_fit - unpickle the &#39;.pkl&#39; file, show the plot, and</span>
<span class="sd">    return the plot data for each line found (histogram, fit 1, fit 2,</span>
<span class="sd">    etc.).</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lmfit.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianModel</span><span class="p">,</span> <span class="n">LinearModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyarrow</span><span class="w"> </span><span class="kn">import</span> <span class="n">feather</span> <span class="k">as</span> <span class="n">ft</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">signal</span> <span class="k">as</span> <span class="n">sg</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">daplis.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>


<div class="viewcode-block" id="fit_with_gaussian">
<a class="viewcode-back" href="../../../daplis.functions.fits.html#daplis.functions.fits.fit_with_gaussian">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fit_with_gaussian</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pixels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">ft_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e3</span><span class="p">,</span>
    <span class="n">multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">color_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rebeccapurple&quot;</span><span class="p">,</span>
    <span class="n">color_fit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
    <span class="n">title_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">correct_pix_address</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_fit_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">pickle_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">file_offset_abs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit with Gaussian function and plot it.</span>

<span class="sd">    Fits timestamp differences of a pair of pixels with Gaussian</span>
<span class="sd">    function and plots it next to the histogram of the differences.</span>
<span class="sd">    Timestamp differences are collected from a &#39;.feather&#39; file if it</span>
<span class="sd">    exists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to the folder with &#39;.dat&#39; data files or where the</span>
<span class="sd">        &#39;.feather&#39; file with timestamp differences is located.</span>
<span class="sd">    pixels : List[int] | List[List[int]]</span>
<span class="sd">        List of pixel numbers for which the timestamp differences should</span>
<span class="sd">        be calculated and saved or list of two lists with pixel numbers</span>
<span class="sd">        for peak vs. peak calculations.</span>
<span class="sd">    ft_file : str, optional</span>
<span class="sd">        Name of the &#39;.feather&#39; file to use for plotting. Can be used</span>
<span class="sd">        when the raw &#39;.dat&#39; data is not available. The default is None.</span>
<span class="sd">    window : float, optional</span>
<span class="sd">        Time range in which timestamp differences are fitted. The</span>
<span class="sd">        default is 5e3.</span>
<span class="sd">    multiplier : int, optional</span>
<span class="sd">        Bins of delta t histogram should be in units of 17.857 (average</span>
<span class="sd">        LinoSPAD2 TDC bin width), this parameter helps with changing the</span>
<span class="sd">        bin size while maintaining that rule. Default is 1.</span>
<span class="sd">    color_data : str, optional</span>
<span class="sd">        For changing the color of the data. The default is &quot;rebeccapurple&quot;.</span>
<span class="sd">    color_fit : str, optional</span>
<span class="sd">        For changing the color of the fit. The default is &quot;darkorange&quot;.</span>
<span class="sd">    title_on : bool, optional</span>
<span class="sd">        Switch for turning on/off the title of the plot, the title</span>
<span class="sd">        shows the pixels for which the fit is done. The default is True.</span>
<span class="sd">    correct_pix_address : bool, optional</span>
<span class="sd">        Correct pixel address for the FPGA board on side 23. The</span>
<span class="sd">        default is False.</span>
<span class="sd">    return_fit_params : bool, optional</span>
<span class="sd">        Switch for returning the fit parameters for further analysis.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    pickle_figure : bool, optional</span>
<span class="sd">        Switch for pickling the plot. Can be used to extract the plot</span>
<span class="sd">        data. The default is False.</span>
<span class="sd">    file_offset_abs : str, optional</span>
<span class="sd">        Absolute path to the &#39;.npy&#39; file with the offset calibration</span>
<span class="sd">        for the particular board. The default is None.</span>


<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if no &#39;.dat&#39; data files are found.</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if no &#39;.feather&#39; file with timestamp differences is found.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if no data for the requested pair of pixels is found</span>
<span class="sd">        in the &#39;.feather&#39; file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame.</span>
<span class="sd">        A dataframe with fit parameters and their standard errors.</span>
<span class="sd">        Returned only if the &quot;return_fit_params&quot; is set to True.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Correct pixel addressing for motherboard on side &#39;23&#39;</span>
    <span class="k">if</span> <span class="n">correct_pix_address</span><span class="p">:</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">correct_pixels_address</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

    <span class="c1"># Handle the input pixel list</span>
    <span class="n">pixels_left</span><span class="p">,</span> <span class="n">pixels_right</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pixel_list_transform</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

    <span class="c1"># If name of the &#39;.feather&#39; file is not provided, get it based on</span>
    <span class="c1"># the &#39;.dat&#39; files in the folder</span>
    <span class="k">if</span> <span class="n">ft_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">ft_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">feather_file_name</span> <span class="o">=</span> <span class="n">ft_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.dat*&quot;</span><span class="p">))</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;delta_ts_data&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File with data not found&quot;</span><span class="p">)</span>

        <span class="n">feather_file_name</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.feather*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">feather_file_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File with data not found&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feather_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pix_left</span> <span class="ow">in</span> <span class="n">pixels_left</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pix_right</span> <span class="ow">in</span> <span class="n">pixels_right</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data for </span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Check if there any finite values</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data for </span><span class="si">{</span><span class="n">pixels_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pixels_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span>

            <span class="c1"># Use the given window for trimming the data for fitting</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">window</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">})</span>

            <span class="c1"># Bins must be in units of 17.857 ps (2500/140)</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span>
                <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Calculate histogram of timestamp differences for primary guess</span>
            <span class="c1"># of fit parameters and selecting a narrower window for the fit</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">n_argmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find position of histogram max&quot;</span><span class="p">)</span>

            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">[</span><span class="n">n_argmax</span><span class="p">]</span> <span class="o">-</span> <span class="n">window</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">[</span><span class="n">n_argmax</span><span class="p">]</span> <span class="o">+</span> <span class="n">window</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">file_offset_abs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_offset_abs</span><span class="p">)</span>
                    <span class="n">delay_pix1</span> <span class="o">=</span> <span class="n">data_offset</span><span class="p">[</span><span class="n">pix_left</span><span class="p">]</span>
                    <span class="n">delay_pix2</span> <span class="o">=</span> <span class="n">data_offset</span><span class="p">[</span><span class="n">pix_right</span><span class="p">]</span>
                    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span> <span class="o">-</span> <span class="n">delay_pix1</span> <span class="o">+</span> <span class="n">delay_pix2</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;No absolute path to the &#39;.npy&#39; file with &quot;</span>
                        <span class="s2">&quot;the offset calibration data was provided. Offset &quot;</span>
                        <span class="s2">&quot;calibration is not applied.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">pass</span>

            <span class="c1"># Bins must be in units of 17.857 ps (2500/140)</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span>
                <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">n</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

            <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="n">par</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fit_gaussian</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

            <span class="c1"># Interpolate for smoother fit plot</span>
            <span class="n">to_fit_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">to_fit_n</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">to_fit_b</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

            <span class="n">perr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>
            <span class="n">contrast</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">contrast_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">error_propagation_division</span><span class="p">(</span>
                <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">perr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">perr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Contrast error in %</span>
            <span class="n">contrast_error</span> <span class="o">=</span> <span class="n">contrast_error</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="c1"># Prepare dataframe for fit parameters, if return of them is</span>
            <span class="c1"># requested</span>
            <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
                <span class="n">params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="n">params_df</span><span class="p">[</span><span class="s2">&quot;Fit parameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;center (ps)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;center_error (ps)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sigma (ps)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sigma_error (ps)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;contrast (%)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;contrast_error (%)&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">params_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Peak at </span><span class="si">{</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">perr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">perr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">contrast</span><span class="p">,</span>
                    <span class="n">contrast_error</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">fit_params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_df</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta$t (ps)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;# of coincidences (-)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="n">n</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color_data</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">to_fit_b</span><span class="p">,</span>
                <span class="n">to_fit_n</span><span class="p">,</span>
                <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color_fit</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fit</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\u03c3</span><span class="s2">=(</span><span class="si">{p1}</span><span class="se">\u00b1</span><span class="si">{pe1}</span><span class="s2">) ps</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\u03bc</span><span class="s2">=(</span><span class="si">{p2}</span><span class="se">\u00b1</span><span class="si">{pe2}</span><span class="s2">) ps</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;C=(</span><span class="si">{contrast}</span><span class="se">\u00b1</span><span class="si">{contrast_error}</span><span class="s2">) %</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;bkg=</span><span class="si">{bkg}</span><span class="se">\u00b1</span><span class="si">{bkg_er}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">p1</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                    <span class="n">p2</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                    <span class="n">pe1</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                    <span class="n">pe2</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                    <span class="n">bkg</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                    <span class="n">bkg_er</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                    <span class="n">contrast</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">),</span>
                    <span class="n">contrast_error</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">contrast_error</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">title_on</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
                    <span class="s2">&quot;Gaussian fit of delta t histogram, pixels &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>

            <span class="c1"># fig.tight_layout()  # for perfect spacing between the plots</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">_fit.png&quot;</span><span class="p">)</span>

            <span class="c1"># Pickle the figure if requested</span>
            <span class="k">if</span> <span class="n">pickle_figure</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">_fit.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fit_params</span> <span class="k">if</span> <span class="n">return_fit_params</span> <span class="k">else</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="fit_with_gaussian_combine">
<a class="viewcode-back" href="../../../daplis.functions.fits.html#daplis.functions.fits.fit_with_gaussian_combine">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fit_with_gaussian_combine</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pixels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">ft_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e3</span><span class="p">,</span>
    <span class="n">multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">color_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rebeccapurple&quot;</span><span class="p">,</span>
    <span class="n">color_fit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
    <span class="n">title_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">correct_pix_address</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_fit_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">pickle_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">file_offset_abs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit with Gaussian function and plot it, merging the pixels.</span>

<span class="sd">    Fits timestamp differences of a pair of pixels with Gaussian</span>
<span class="sd">    function and plots it next to the histogram of the differences.</span>
<span class="sd">    Timestamp differences are collected from a &#39;.feather&#39; file if it</span>
<span class="sd">    exists. Merges the data from all pixel pairs requested into a</span>
<span class="sd">    single peak.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to the folder with &#39;.dat&#39; data files or where the</span>
<span class="sd">        &#39;.feather&#39; file with timestamp differences is located.</span>
<span class="sd">    pixels : List[int] | List[List[int]]</span>
<span class="sd">        List of pixel numbers for which the timestamp differences should</span>
<span class="sd">        be calculated and saved or list of two lists with pixel numbers</span>
<span class="sd">        for peak vs. peak calculations.</span>
<span class="sd">    ft_file : str, optional</span>
<span class="sd">        Name of the &#39;.feather&#39; file to use for plotting. Can be used</span>
<span class="sd">        when the raw &#39;.dat&#39; data is not available. The default is None.</span>
<span class="sd">    window : float, optional</span>
<span class="sd">        Time range in which timestamp differences are fitted. The</span>
<span class="sd">        default is 5e3.</span>
<span class="sd">    multiplier : int, optional</span>
<span class="sd">        Bins of delta t histogram should be in units of 17.857 (average</span>
<span class="sd">        LinoSPAD2 TDC bin width), this parameter helps with changing the</span>
<span class="sd">        bin size while maintaining that rule. Default is 1.</span>
<span class="sd">    color_data : str, optional</span>
<span class="sd">        For changing the color of the data. The default is &quot;rebeccapurple&quot;.</span>
<span class="sd">    color_fit : str, optional</span>
<span class="sd">        For changing the color of the fit. The default is &quot;darkorange&quot;.</span>
<span class="sd">    title_on : bool, optional</span>
<span class="sd">        Switch for turning on/off the title of the plot, the title</span>
<span class="sd">        shows the pixels for which the fit is done. The default is True.</span>
<span class="sd">    correct_pix_address : bool, optional</span>
<span class="sd">        Correct pixel address for the FPGA board on side 23. The</span>
<span class="sd">        default is False.</span>
<span class="sd">    return_fit_params : bool, optional</span>
<span class="sd">        Switch for returning the fit parameters for further analysis.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    pickle_figure : bool, optional</span>
<span class="sd">        Switch for pickling the plot. Can be used to extract the plot</span>
<span class="sd">        data. The default is False.</span>
<span class="sd">    file_offset_abs : str, optional</span>
<span class="sd">        Absolute path to the &#39;.npy&#39; file with the offset calibration</span>
<span class="sd">        for the particular board. The default is None.</span>


<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if no &#39;.dat&#39; data files are found.</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if no &#39;.feather&#39; file with timestamp differences is found.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if no data for the requested pair of pixels is found</span>
<span class="sd">        in the &#39;.feather&#39; file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame.</span>
<span class="sd">        A dataframe with fit parameters and their standard errors.</span>
<span class="sd">        Returned only if the &quot;return_fit_params&quot; is set to True.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Correct pixel addressing for motherboard on side &#39;23&#39;</span>
    <span class="k">if</span> <span class="n">correct_pix_address</span><span class="p">:</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">correct_pixels_address</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

    <span class="c1"># Handle the input pixel list</span>
    <span class="n">pixels_left</span><span class="p">,</span> <span class="n">pixels_right</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pixel_list_transform</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

    <span class="c1"># If name of the &#39;.feather&#39; file is not provided, get it based on</span>
    <span class="c1"># the &#39;.dat&#39; files in the folder</span>
    <span class="k">if</span> <span class="n">ft_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">ft_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">feather_file_name</span> <span class="o">=</span> <span class="n">ft_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.dat*&quot;</span><span class="p">))</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;delta_ts_data&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File with data not found&quot;</span><span class="p">)</span>

        <span class="n">feather_file_name</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.feather*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">feather_file_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File with data not found&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feather_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">data_merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_merged</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pix_left</span> <span class="ow">in</span> <span class="n">pixels_left</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pix_right</span> <span class="ow">in</span> <span class="n">pixels_right</span><span class="p">:</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

            <span class="c1"># Check if there any finite values</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No data for the requested pixel pair available&quot;</span>
                <span class="p">)</span>

            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span>

            <span class="c1"># Use the given window for trimming the data for fitting</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">window</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">})</span>

            <span class="c1"># Bins must be in units of 17.857 ps (2500/140)</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span>
                <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Calculate histogram of timestamp differences for primary guess</span>
            <span class="c1"># of fit parameters and selecting a narrower window for the fit</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">n_argmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find position of histogram max&quot;</span><span class="p">)</span>

            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">[</span><span class="n">n_argmax</span><span class="p">]</span> <span class="o">-</span> <span class="n">window</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">[</span><span class="n">n_argmax</span><span class="p">]</span> <span class="o">+</span> <span class="n">window</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">file_offset_abs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_offset_abs</span><span class="p">)</span>
                    <span class="n">delay_pix1</span> <span class="o">=</span> <span class="n">data_offset</span><span class="p">[</span><span class="n">pix_left</span><span class="p">]</span>
                    <span class="n">delay_pix2</span> <span class="o">=</span> <span class="n">data_offset</span><span class="p">[</span><span class="n">pix_right</span><span class="p">]</span>
                    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span> <span class="o">-</span> <span class="n">delay_pix1</span> <span class="o">+</span> <span class="n">delay_pix2</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;No absolute path to the &#39;.npy&#39; file with &quot;</span>
                        <span class="s2">&quot;the offset calibration data was provided. Offset &quot;</span>
                        <span class="s2">&quot;calibration is not applied.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">pass</span>

            <span class="n">data_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">data_merged</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)))</span>

    <span class="c1"># Bins must be in units of 17.857 ps (2500/140)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_merged</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_merged</span><span class="p">),</span>
        <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">n</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_merged</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

    <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">par</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fit_gaussian</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c1"># Interpolate for smoother fit plot</span>
    <span class="n">to_fit_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">),</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">to_fit_n</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">to_fit_b</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">perr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">contrast_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">error_propagation_division</span><span class="p">(</span>
        <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">perr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">perr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Contrast error in %</span>
    <span class="n">contrast_error</span> <span class="o">=</span> <span class="n">contrast_error</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="c1"># Prepare dataframe for fit parameters, if return of them is</span>
    <span class="c1"># requested</span>
    <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
        <span class="n">params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">params_df</span><span class="p">[</span><span class="s2">&quot;Fit parameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;center (ps)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;center_error (ps)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sigma (ps)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sigma_error (ps)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;contrast (%)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;contrast_error (%)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">params_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Peak at </span><span class="si">{</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">perr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">perr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">contrast</span><span class="p">,</span>
            <span class="n">contrast_error</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pixels_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pixels_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_df</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta$t (ps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;# of coincidences (-)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
        <span class="n">n</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color_data</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">to_fit_b</span><span class="p">,</span>
        <span class="n">to_fit_n</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color_fit</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fit</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\u03c3</span><span class="s2">=(</span><span class="si">{p1}</span><span class="se">\u00b1</span><span class="si">{pe1}</span><span class="s2">) ps</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\u03bc</span><span class="s2">=(</span><span class="si">{p2}</span><span class="se">\u00b1</span><span class="si">{pe2}</span><span class="s2">) ps</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;C=(</span><span class="si">{contrast}</span><span class="se">\u00b1</span><span class="si">{contrast_error}</span><span class="s2">) %</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;bkg=</span><span class="si">{bkg}</span><span class="se">\u00b1</span><span class="si">{bkg_er}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">p1</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">p2</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">pe1</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">pe2</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">bkg</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">bkg_er</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">contrast</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">),</span>
            <span class="n">contrast_error</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">contrast_error</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title_on</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
            <span class="s2">&quot;Gaussian fit of delta t histogram,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;pixels </span><span class="si">{</span><span class="n">pixels_left</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pixels_right</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>

    <span class="c1"># fig.tight_layout()  # for perfect spacing between the plots</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pixels_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pixels_right</span><span class="si">}</span><span class="s2">_fit.png&quot;</span><span class="p">)</span>

    <span class="c1"># Pickle the figure if requested</span>
    <span class="k">if</span> <span class="n">pickle_figure</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pixels_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pixels_right</span><span class="si">}</span><span class="s2">_fit.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fit_params</span> <span class="k">if</span> <span class="n">return_fit_params</span> <span class="k">else</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="fit_with_gaussian_all">
<a class="viewcode-back" href="../../../daplis.functions.fits.html#daplis.functions.fits.fit_with_gaussian_all">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fit_with_gaussian_all</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pixels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">ft_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold_multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">,</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e3</span><span class="p">,</span>
    <span class="n">multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">color_d</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rebeccapurple&quot;</span><span class="p">,</span>
    <span class="n">color_f</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
    <span class="n">title_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">correct_pix_address</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_fit_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">pickle_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find all peaks above threshold and fit each with Gaussian.</span>

<span class="sd">    Finds all peaks above the given threshold (uses the &#39;threshold_multiplier&#39;</span>
<span class="sd">    parameter as a multiplier of the median) and fits each with a</span>
<span class="sd">    Gaussian function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to the folder with &#39;.dat&#39; data files or where the</span>
<span class="sd">        &#39;.feather&#39; file with timestamp differences is located.</span>
<span class="sd">    pixels : List[int] | List[List[int]]</span>
<span class="sd">        List of pixel numbers for which the timestamp differences should</span>
<span class="sd">        be calculated and saved or list of two lists with pixel numbers</span>
<span class="sd">        for peak vs. peak calculations.</span>
<span class="sd">    ft_file : str, optional</span>
<span class="sd">        Name of the &#39;.feather&#39; file to use for plotting. Can be used</span>
<span class="sd">        when the raw &#39;.dat&#39; data is not available. The default is None.</span>
<span class="sd">    threshold_multiplier : float, optional</span>
<span class="sd">        Multiplier for the median of the histogram counts. Used for</span>
<span class="sd">        setting a threshold for the peak discovery in the histogram.</span>
<span class="sd">        The default is 1.2, or 20% above the median.</span>
<span class="sd">    window : float, optional</span>
<span class="sd">        Time range in which timestamp differences are fitted. The</span>
<span class="sd">        default is 5e3.</span>
<span class="sd">    multiplier : int, optional</span>
<span class="sd">        Bins of delta t histogram should be in units of 17.857 (average</span>
<span class="sd">        LinoSPAD2 TDC bin width). Default is 1.</span>
<span class="sd">    color_d : str, optional</span>
<span class="sd">        Color for the histogram. The default is &quot;rebeccapurple&quot;.</span>
<span class="sd">    color_f : str, optional</span>
<span class="sd">        Color for the fit with Gaussian. The default is &quot;darkorange&quot;.</span>
<span class="sd">    title_on : bool, optional</span>
<span class="sd">        Switch for showing the plot title. The default is &quot;True&quot;.</span>
<span class="sd">    correct_pix_address : bool, optional</span>
<span class="sd">        Correct pixel address for the FPGA board on side 23. The</span>
<span class="sd">        default is False.</span>
<span class="sd">    return_fit_params : bool, optional</span>
<span class="sd">        Switch for returning the fit parameters for further analysis.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    pickle_figure : bool, optional</span>
<span class="sd">        Switch for pickling the plot. Can be used to extract the plot</span>
<span class="sd">        data. The default is False.</span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised when no &#39;.dat&#39; data files are found.</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised when no &#39;.feather&#39; file with timestamp differences is</span>
<span class="sd">        found.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised when no data for the requested pair of pixels was found</span>
<span class="sd">        in the &#39;.feather&#39; file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataFrame.</span>
<span class="sd">        A dataframe with fit parameters and their standard errors.</span>
<span class="sd">        Returned only if the &quot;return_fit_params&quot; is set to True.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Correct pixel addressing for motherboard on side &#39;23&#39;</span>
    <span class="k">if</span> <span class="n">correct_pix_address</span><span class="p">:</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">correct_pixels_address</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

    <span class="c1"># Handle the input pixel list</span>
    <span class="n">pixels_left</span><span class="p">,</span> <span class="n">pixels_right</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pixel_list_transform</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

    <span class="c1"># If name of the &#39;.feather&#39; file is not provided, get it based on</span>
    <span class="c1"># the &#39;.dat&#39; files in the folder</span>
    <span class="k">if</span> <span class="n">ft_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">ft_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">feather_file_name</span> <span class="o">=</span> <span class="n">ft_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.dat*&quot;</span><span class="p">))</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;delta_ts_data&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File with data not found&quot;</span><span class="p">)</span>

        <span class="n">feather_file_name</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.feather*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">feather_file_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File with data not found&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feather_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">pix_left</span> <span class="ow">in</span> <span class="n">pixels_left</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pix_right</span> <span class="ow">in</span> <span class="n">pixels_right</span><span class="p">:</span>

            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

            <span class="c1"># Check if there any finite values</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No data for the requested pixel pair available&quot;</span>
                <span class="p">)</span>

            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span>

            <span class="c1"># Use the given window for trimming the data for fitting</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">window</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">})</span>

            <span class="c1"># Bins must be in units of 17.857 ps (2500/140)</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span>
                <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Calculate histogram of timestamp differences for primary guess</span>
            <span class="c1"># of fit parameters and selecting a narrower window for the fit</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

            <span class="n">bin_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="n">peak_pos</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">threshold_multiplier</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta$t (ps)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;# of coincidences (-)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
                <span class="n">bin_c</span><span class="p">,</span>
                <span class="n">n</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color_d</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">color_f</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
                <span class="s2">&quot;#ffa64e&quot;</span><span class="p">,</span>
                <span class="s2">&quot;#c16b0f&quot;</span><span class="p">,</span>
                <span class="s2">&quot;#ffbf81&quot;</span><span class="p">,</span>
                <span class="s2">&quot;#874d13&quot;</span><span class="p">,</span>
                <span class="s2">&quot;#ff9931&quot;</span><span class="p">,</span>
                <span class="s2">&quot;#e07c09&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span>
                <span class="p">[</span><span class="o">-</span><span class="mf">20e3</span><span class="p">,</span> <span class="o">-</span><span class="mf">10e3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">10e3</span><span class="p">,</span> <span class="mf">20e3</span><span class="p">],</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="mf">20e3</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="mf">10e3</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">0</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mf">10e3</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mf">20e3</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Peak 1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Peak 2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Peak 3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Peak 4&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Peak 5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Peak 6&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Peak 7&quot;</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="c1"># Prepare dataframe for fit parameters, if return of them is</span>
            <span class="c1"># requested</span>
            <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
                <span class="n">params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">peak_pos</span><span class="p">:</span>
                    <span class="n">params_df</span><span class="p">[</span><span class="s2">&quot;Fit parameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;center (ps)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;center_error (ps)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;sigma (ps)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;sigma_error (ps)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;contrast (%)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;contrast_error (%)&quot;</span><span class="p">,</span>
                    <span class="p">]</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">peak_ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peak_pos</span><span class="p">):</span>
                <span class="n">data_to_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                    <span class="n">data_to_plot</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="n">bin_c</span><span class="p">[</span><span class="n">peak_ind</span><span class="p">]</span> <span class="o">-</span> <span class="mf">3e3</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">data_to_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                    <span class="n">data_to_fit</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_fit</span> <span class="o">&gt;</span> <span class="n">bin_c</span><span class="p">[</span><span class="n">peak_ind</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3e3</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Bins must be in units of 17.857 ps (2500/140)</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_to_fit</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_to_fit</span><span class="p">),</span>
                    <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">counts</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_to_fit</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

                <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span> <span class="o">-</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)[</span>
                    <span class="mi">1</span><span class="p">:</span>
                <span class="p">]</span>

                <span class="n">par</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fit_gaussian</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>

                <span class="c1"># Interpolate for smoother fit plot</span>
                <span class="n">to_fit_n1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span>
                    <span class="n">bin_centers</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">perr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>

                <span class="n">contrast</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">par</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="n">contrast_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">error_propagation_division</span><span class="p">(</span>
                    <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">perr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">perr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">contrast_error</span> <span class="o">=</span> <span class="n">contrast_error</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="c1"># Add the fit parameters to the dataframe for returning</span>
                <span class="c1"># if requested</span>
                <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
                    <span class="n">params_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Peak at </span><span class="si">{</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">perr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="n">perr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="n">contrast</span><span class="p">,</span>
                        <span class="n">contrast_error</span><span class="p">,</span>
                    <span class="p">]</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">bin_centers</span><span class="p">,</span>
                    <span class="n">to_fit_n1</span><span class="p">,</span>
                    <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">color_f</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\u03c3</span><span class="s2">=(</span><span class="si">{p1}</span><span class="se">\u00b1</span><span class="si">{pe1}</span><span class="s2">) ps</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\u03bc</span><span class="s2">=(</span><span class="si">{p2}</span><span class="se">\u00b1</span><span class="si">{pe2}</span><span class="s2">) ps</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;C=(</span><span class="si">{contrast}</span><span class="se">\u00b1</span><span class="si">{contrast_error}</span><span class="s2">) %&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">labels</span><span class="p">,</span>
                        <span class="n">p1</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                        <span class="n">p2</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                        <span class="n">pe1</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                        <span class="n">pe2</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
                        <span class="n">contrast</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">),</span>
                        <span class="n">contrast_error</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">contrast_error</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">lower_limit</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">upper_limit</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">data_in_interval</span> <span class="o">=</span> <span class="n">data_to_fit</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">data_to_fit</span> <span class="o">&gt;=</span> <span class="n">lower_limit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_to_fit</span> <span class="o">&lt;=</span> <span class="n">upper_limit</span><span class="p">)</span>
                <span class="p">]</span>

                <span class="n">bckg_center_position</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">bckg_in_2sigma</span> <span class="o">=</span> <span class="n">data_to_fit</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">data_to_fit</span> <span class="o">&gt;</span> <span class="n">bckg_center_position</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_to_fit</span> <span class="o">&lt;</span> <span class="n">bckg_center_position</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">]</span>

                <span class="c1"># Plot the Gaussian fit and the 2-sigma interval</span>
                <span class="n">er1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_in_interval</span><span class="p">))</span>
                <span class="n">er2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bckg_in_2sigma</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
                <span class="n">fit_params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_df</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="n">window</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">title_on</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
                    <span class="s2">&quot;Gaussian fit of delta t histogram, pixels &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;results/fits&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">_all_fit.png&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Pickle the figure if requested</span>
            <span class="k">if</span> <span class="n">pickle_figure</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">_all_fit.pkl&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;wb&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fit_params</span> <span class="k">if</span> <span class="n">return_fit_params</span> <span class="k">else</span> <span class="kc">None</span></div>



<span class="c1"># TODO no data to test full sensor plot</span>
<span class="c1"># TODO add pickling plot</span>
<div class="viewcode-block" id="fit_with_gaussian_full_sensor">
<a class="viewcode-back" href="../../../daplis.functions.fits.html#daplis.functions.fits.fit_with_gaussian_full_sensor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fit_with_gaussian_full_sensor</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="n">pix_pair</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e3</span><span class="p">,</span>
    <span class="n">multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">color_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rebeccapurple&quot;</span><span class="p">,</span>
    <span class="n">color_fit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
    <span class="n">title_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit with Gaussian function and plot it.</span>

<span class="sd">    Fits timestamp differences of a pair of pixels with Gaussian</span>
<span class="sd">    function and plots it next to the histogram of the differences.</span>
<span class="sd">    Timestamp differences are collected from a &#39;.feather&#39; file with</span>
<span class="sd">    those if such exists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to the folder with &#39;.dat&#39; data files.</span>
<span class="sd">    pix_pair : list</span>
<span class="sd">        Two pixel numbers for which fit is done.</span>
<span class="sd">    window : float, optional</span>
<span class="sd">        Time range in which timestamp differences are fitted. The</span>
<span class="sd">        default is 5e3.</span>
<span class="sd">    multiplier : int, optional</span>
<span class="sd">        Bins of delta t histogram should be in units of 17.857 (average</span>
<span class="sd">        LinoSPAD2 TDC bin width), this parameter helps with changing the</span>
<span class="sd">        bin size while maintaining that rule. Default is 1.</span>
<span class="sd">    color_data : str, optional</span>
<span class="sd">        For changing the color of the data. The default is &quot;rebeccapurple&quot;.</span>
<span class="sd">    color_fit : str, optional</span>
<span class="sd">        For changing the color of the fit. The default is &quot;darkorange&quot;.</span>
<span class="sd">    title_on : bool, optional</span>
<span class="sd">        Switch for turning on/off the title of the plot, the title</span>
<span class="sd">        shows the pixels for which the fit is done. The default is True.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised when no &#39;.dat&#39; data files are found.</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised when no &#39;.feather&#39; file with timestamp differences is found.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised when no data for the requested pair of pixels was found</span>
<span class="sd">        in the &#39;.feather&#39; file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Assuming the current directory contains the folders</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*#*&quot;</span><span class="p">)</span>

    <span class="c1"># Ensure at least two folders are found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;At least two folders with the specified pattern are required.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Depending on the order of the folders, the &quot;.feather&quot; file naming</span>
    <span class="c1"># could be different. The following code collects the names for</span>
    <span class="c1"># the two possible naming results</span>

    <span class="c1"># Collect &quot;.dat&quot; files&#39; names in the first folder</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">folders</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">files_all</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.dat*&quot;</span><span class="p">))</span>
    <span class="n">feather_file_name1</span> <span class="o">=</span> <span class="n">files_all</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
    <span class="n">feather_file_name2</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">files_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># Collect &quot;.dat&quot; files&#39; names in the second folder</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;../</span><span class="si">{</span><span class="n">folders</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">files_all</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.dat&quot;</span><span class="p">))</span>
    <span class="n">feather_file_name1</span> <span class="o">+=</span> <span class="n">files_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">feather_file_name2</span> <span class="o">=</span> <span class="n">files_all</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">feather_file_name2</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>

    <span class="n">feather_file_path1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;delta_ts_data/</span><span class="si">{</span><span class="n">feather_file_name1</span><span class="si">}</span><span class="s2">.feather&quot;</span>
    <span class="n">feather_file_path2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;delta_ts_data/</span><span class="si">{</span><span class="n">feather_file_name2</span><span class="si">}</span><span class="s2">.feather&quot;</span>
    <span class="n">feather_file</span><span class="p">,</span> <span class="n">feather_file_name</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">feather_file_path1</span><span class="p">,</span> <span class="n">feather_file_name1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">feather_file_path1</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">(</span><span class="n">feather_file_path2</span><span class="p">,</span> <span class="n">feather_file_name2</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">feather_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="s2">&quot;&#39;.feather&#39; file with timestamps differences was not found&quot;</span>
        <span class="p">)</span>

    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feather_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># Check if there any finite values</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No data for the requested pixel pair available&quot;</span><span class="p">)</span>

    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span>

    <span class="c1"># Use the given window for trimming the data for fitting</span>
    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">window</span><span class="p">))</span>
    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">})</span>

    <span class="c1"># Bins must be in units of 17.857 ps (2500/140)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span> <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="p">)</span>

    <span class="c1"># Calculate histogram of timestamp differences for primary guess</span>
    <span class="c1"># of fit parameters and selecting a narrower window for the fit</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">n_argmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">cp_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">n_argmax</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="n">n_argmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find position of histogram max&quot;</span><span class="p">)</span>

    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
        <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">[</span><span class="n">n_argmax</span><span class="p">]</span> <span class="o">-</span> <span class="n">window</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
        <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">[</span><span class="n">n_argmax</span><span class="p">]</span> <span class="o">+</span> <span class="n">window</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Bins must be in units of 17.857 ps (2500/140)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span> <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="p">)</span>

    <span class="n">n</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>

    <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">par</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fit_gaussian</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c1"># Interpolate for smoother fit plot</span>
    <span class="n">to_fit_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="p">)</span>
    <span class="n">to_fit_n</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">to_fit_b</span><span class="p">,</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">perr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">contrast_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">error_propagation_division</span><span class="p">(</span>
        <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">perr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">perr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Contrast error in %</span>
    <span class="n">contrast_error</span> <span class="o">=</span> <span class="n">contrast_error</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta$t (ps)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;# of coincidences (-)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
        <span class="n">n</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color_data</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">to_fit_b</span><span class="p">,</span>
        <span class="n">to_fit_n</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color_fit</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fit</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\u03c3</span><span class="s2">=(</span><span class="si">{p1}</span><span class="se">\u00b1</span><span class="si">{pe1}</span><span class="s2">) ps</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="se">\u03bc</span><span class="s2">=(</span><span class="si">{p2}</span><span class="se">\u00b1</span><span class="si">{pe2}</span><span class="s2">) ps</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;C=(</span><span class="si">{contrast}</span><span class="se">\u00b1</span><span class="si">{vis_er}</span><span class="s2">) %</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;bkg=</span><span class="si">{bkg}</span><span class="se">\u00b1</span><span class="si">{bkg_er}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">p1</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">p2</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">pe1</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">pe2</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">bkg</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">bkg_er</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">perr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;.0f&quot;</span><span class="p">),</span>
            <span class="n">contrast</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">),</span>
            <span class="n">vis_er</span><span class="o">=</span><span class="nb">format</span><span class="p">(</span><span class="n">contrast_error</span><span class="p">,</span> <span class="s2">&quot;.1f&quot;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title_on</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
            <span class="s2">&quot;Gaussian fit of delta t histogram, pixels &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">pix_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;results/fits&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;results/fits&quot;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;results/fits&quot;</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># for perfect spacing between the plots</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feather_file_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pix_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_fit.png&quot;</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="fit_with_gaussian_fancy">
<a class="viewcode-back" href="../../../daplis.functions.fits.html#daplis.functions.fits.fit_with_gaussian_fancy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fit_with_gaussian_fancy</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pixels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">ft_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">range_left</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5e3</span><span class="p">,</span>
    <span class="n">range_right</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e3</span><span class="p">,</span>
    <span class="n">multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_fit_params</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">interpolate_fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">correct_pix_address</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">pickle_figure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit with Gaussian function and plot it, using lmfit library.</span>

<span class="sd">    Fits timestamp differences of a pair of pixels with Gaussian</span>
<span class="sd">    function and plots it over to the histogram of the differences.</span>
<span class="sd">    Timestamp differences are collected from a &#39;.feather&#39; file.</span>
<span class="sd">    Additionally, the residuals are calculated and plotted below the</span>
<span class="sd">    data and fit, together with a normal distribution of them.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to the folder with &#39;.dat&#39; data files or where the</span>
<span class="sd">        &#39;.feather&#39; file with timestamp differences is located.</span>
<span class="sd">    pixels : List[int] | List[List[int]]</span>
<span class="sd">        List of pixel numbers for which the timestamp differences should</span>
<span class="sd">        be calculated and saved or list of two lists with pixel numbers</span>
<span class="sd">        for peak vs. peak calculations.</span>
<span class="sd">    ft_file : str, optional</span>
<span class="sd">        Name of the &#39;.feather&#39; file with the timestamp differences.</span>
<span class="sd">        Should be provided when the data files are not available. The</span>
<span class="sd">        default is None.</span>
<span class="sd">    range_left : float, optional</span>
<span class="sd">        Left limit for the signal window. The default is -5e3.</span>
<span class="sd">    range_right : float, optional</span>
<span class="sd">        Right limit for the signal window. The default is 5e3.</span>
<span class="sd">    multiplier : int, optional</span>
<span class="sd">        Bins of delta t histogram should be in units of 17.857 (average</span>
<span class="sd">        LinoSPAD2 TDC bin width), this parameter helps with changing the</span>
<span class="sd">        bin size while maintaining that rule. Default is 1.</span>
<span class="sd">    normalize : bool, optional</span>
<span class="sd">        Switch for normalizing the plot to median. The default is False.</span>
<span class="sd">    return_fit_parameters : bool, optional</span>
<span class="sd">        Switch for returning the fit parameters as they are returned</span>
<span class="sd">        by the lmfit library. The default is False.</span>
<span class="sd">    interpolate_fit: bool, optional</span>
<span class="sd">        Switch for an interpolated fit. The default is True.</span>
<span class="sd">    correct_pix_address : bool, optional</span>
<span class="sd">        Correct pixel address for the FPGA board on side 23. The</span>
<span class="sd">        default is False.</span>
<span class="sd">    pickle_figure : bool, optional</span>
<span class="sd">        Switch for pickling the plot. Can be used to extract the plot</span>
<span class="sd">        data. The default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lmfit.parameter.Parameters</span>
<span class="sd">        Parameters of the fit as returned by the lmfit library. Returned</span>
<span class="sd">        only if the &quot;return_fit_params&quot; is set to True.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if the &#39;delta_ts_data&#39; folder was not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Correct pixel addressing for motherboard on side &#39;23&#39;</span>
    <span class="k">if</span> <span class="n">correct_pix_address</span><span class="p">:</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">correct_pixels_address</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

    <span class="c1"># Handle the input pixel list</span>
    <span class="n">pixels_left</span><span class="p">,</span> <span class="n">pixels_right</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pixel_list_transform</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>

    <span class="c1"># If name of the &#39;.feather&#39; file is not provided, get it based on</span>
    <span class="c1"># the &#39;.dat&#39; files in the folder</span>
    <span class="k">if</span> <span class="n">ft_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">ft_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">feather_file_name</span> <span class="o">=</span> <span class="n">ft_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.dat*&quot;</span><span class="p">))</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;delta_ts_data&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s2">&quot;Folder &#39;delta_ts_data&#39; with the &quot;</span>
                <span class="s2">&quot;timestamps differences was not found.&quot;</span>
            <span class="p">)</span>

        <span class="n">feather_file_name</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.feather*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># # Select the column of delta ts for the requested pair of pixels</span>
    <span class="c1"># if pix_pair is not None:</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         data = ft.read_feather(</span>
    <span class="c1">#             ft_file,</span>
    <span class="c1">#             columns=[f&quot;{pix_pair[0]},{pix_pair[1]}&quot;],</span>
    <span class="c1">#         )</span>
    <span class="c1">#     except ArrowInvalid:</span>
    <span class="c1">#         raise ArrowInvalid(</span>
    <span class="c1">#             &quot;Data for the requested pair of pixels were not found&quot;</span>
    <span class="c1">#         )</span>
    <span class="c1"># else:</span>
    <span class="c1">#     data = ft.read_feather(ft_file)</span>
    <span class="c1">#     pix_pair = [int(x) for x in data.columns[0].split(&quot;,&quot;)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">feather_file_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File with data not found&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feather_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pix_left</span> <span class="ow">in</span> <span class="n">pixels_left</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pix_right</span> <span class="ow">in</span> <span class="n">pixels_right</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data for </span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Select a window around the signal</span>
            <span class="n">data_signal</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="p">[</span>
                <span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;=</span> <span class="n">range_left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;=</span> <span class="n">range_right</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

            <span class="c1"># TODO - data problems - wider range for bckg</span>
            <span class="c1"># For SNR - can&#39;t use wider bckg range because of data problems</span>
            <span class="c1"># data_bckg = data[(data &lt; range_left) | (data &gt; range_right)].dropna()</span>

            <span class="c1"># n, _ = np.histogram(data_bckg, bins=200)</span>
            <span class="c1"># bckg_stderr = np.std(n)</span>

            <span class="c1"># Select background data for SNR calculation</span>
            <span class="n">data_bckg</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="p">[</span>
                <span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="n">range_right</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_to_plot</span> <span class="o">&lt;</span> <span class="n">range_right</span> <span class="o">+</span> <span class="mf">10e3</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

            <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_bckg</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

            <span class="c1"># Normalize - same as signal</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="c1"># The divisor in the SNR (signal height / sigma of bckg)</span>
            <span class="n">bckg_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="c1"># Calculate histogram</span>
            <span class="c1"># Scott&#39;s rule for the number of bins</span>

            <span class="k">if</span> <span class="n">multiplier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">number_of_bins</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mf">3.5</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data_signal</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_signal</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">multiplier</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_of_bins</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_signal</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_signal</span><span class="p">),</span>
                    <span class="mi">2500</span> <span class="o">/</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">counts</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_signal</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t calculate bins for </span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Normalize</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

            <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># Composite fit: Gaussian for the peak + linear for bckg of random</span>
            <span class="c1"># coincidences</span>
            <span class="n">model_peak</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">()</span>
            <span class="n">model_bckg</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">()</span>

            <span class="c1"># Guess the initial values of parameters</span>
            <span class="n">params_peak</span> <span class="o">=</span> <span class="n">model_peak</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">)</span>
            <span class="n">params_bckg</span> <span class="o">=</span> <span class="n">model_bckg</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">params_peak</span> <span class="o">+</span> <span class="n">params_bckg</span>

            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;amplitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># params[&quot;height&quot;].max = 1</span>

            <span class="c1"># Combine the models</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_peak</span> <span class="o">+</span> <span class="n">model_bckg</span>

            <span class="c1"># Do the fitting</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">max_nfev</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

            <span class="c1"># For smoother fit</span>
            <span class="k">if</span> <span class="n">interpolate_fit</span><span class="p">:</span>
                <span class="n">fit_bins_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">),</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">fit_counts_plot</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span>
                    <span class="n">fit_bins_plot</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Plot results</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">})</span>
            <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;height_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span>
            <span class="p">)</span>

            <span class="c1"># Data + fit</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">bin_centers</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;rebeccapurple&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">interpolate_fit</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">bin_centers</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gaussian fit&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">fit_bins_plot</span><span class="p">,</span>
                    <span class="n">fit_counts_plot</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gaussian fit&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Counts (-)&quot;</span><span class="p">)</span>
            <span class="c1"># ax1.yaxis.set_label_coords(-0.105, 0.5)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([],</span> <span class="p">[])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mf">2.5e3</span><span class="p">,</span>
                <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mf">2.5e3</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Parameters</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fit_params_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;Fit parameters&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;                           &quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;$\sigma$: (</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;±</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">) ps&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;$\mu$: (</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;±</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">) ps&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;C: (</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;±</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">) %&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;SNR: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bckg_stderr</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> $\sigma$&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">1.05</span><span class="p">,</span>
                <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">fit_params_text</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Plot the residuals</span>
            <span class="n">result</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
                <span class="n">datafmt</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Residuals (-)&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$\Delta$t (ps)&quot;</span><span class="p">)</span>
            <span class="n">ax2_lines</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span>
            <span class="n">ax2_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">ax2_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;rebeccapurple&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mf">2.5e3</span><span class="p">,</span>
                <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mf">2.5e3</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Plot the distribution of residuals with a Gaussian fit</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">-</span> <span class="n">result</span><span class="o">.</span><span class="n">best_fit</span>
            <span class="n">counts_residuals</span><span class="p">,</span> <span class="n">bins_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">bins_residuals_edges</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bins_residuals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins_residuals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">counts_residuals</span><span class="p">,</span>
                <span class="n">bins_residuals_edges</span><span class="p">,</span>
                <span class="s2">&quot;.&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;rebeccapurple&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">model_residuals</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">()</span>
            <span class="n">params_residuals</span> <span class="o">=</span> <span class="n">model_residuals</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span>
                <span class="n">counts_residuals</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">bins_residuals_edges</span>
            <span class="p">)</span>
            <span class="n">result_residuals</span> <span class="o">=</span> <span class="n">model_residuals</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">counts_residuals</span><span class="p">,</span> <span class="n">params_residuals</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">bins_residuals_edges</span>
            <span class="p">)</span>

            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">result_residuals</span><span class="o">.</span><span class="n">best_fit</span><span class="p">,</span>
                <span class="n">bins_residuals_edges</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;$\sigma$: </span><span class="si">{</span><span class="n">result_residuals</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;$\mu$: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">result_residuals</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">y_limits</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_limits</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([],</span> <span class="p">[])</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

            <span class="c1"># Plot the report of the data fit</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>

            <span class="c1"># Save the plot</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;results/fits&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;results/fits&quot;</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;results/fits&quot;</span><span class="p">))</span>

            <span class="c1"># plot_name = ft_file.split(&quot;.&quot;)[0]</span>
            <span class="n">plot_name</span> <span class="o">=</span> <span class="n">file_name</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">_fancy_fit.png&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Pickle the figure if requested</span>
            <span class="k">if</span> <span class="n">pickle_figure</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_pixels_</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">_fancy_fit.pkl&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;wb&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
                <span class="n">fit_params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pix_left</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pix_right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_fit_params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fit_params</span></div>



<div class="viewcode-block" id="unpickle_fit">
<a class="viewcode-back" href="../../../daplis.functions.fits.html#daplis.functions.fits.unpickle_fit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unpickle_fit</span><span class="p">(</span><span class="n">fit_pickle_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unpickle a saved figure and return plot data.</span>

<span class="sd">    Load a pickled figure, extract and return the histogram and fit</span>
<span class="sd">    data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fit_pickle_file : str</span>
<span class="sd">        The absolute path to the pickle file with the fit plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">        - fig (matplotlib.figure.Figure): The unpickled figure object.</span>
<span class="sd">        - plot_data (dict): A dictionary with keys &quot;Histogram&quot; and</span>
<span class="sd">        &quot;Fit_{i}&quot; (for i &gt;= 1), where each value is a tuple of x and y</span>
<span class="sd">        data for the corresponding line plot.</span>
<span class="sd">        - params_df (pandas.DataFrame): A DataFrame containing fit</span>
<span class="sd">        parameters extracted from the legend. Columns represent each</span>
<span class="sd">        fit.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If the specified pickle file does not exist, a FileNotFoundError</span>
<span class="sd">        is raised and an error message is printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fit_pickle_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Pack the data into a dictionary, first is the histogram, others</span>
    <span class="c1"># are the fits</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Extract the data; go over lines, stack them into dictionary</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;Histogram&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Fit_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Pattern for the fit parameters: sigma, mu, C</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;σ=\(([\d.-]+)±([\d.-]+)\) ps\n&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;μ=\(([\d.-]+)±([\d.-]+)\) ps\n&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;C=\(([\d.-]+)±([\d.-]+)\) %&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Prepare a dataframe for the fit parameters</span>
    <span class="n">params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">params_df</span><span class="p">[</span><span class="s2">&quot;Fit parameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;center (ps)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;center_error (ps)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sigma (ps)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sigma_error (ps)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;contrast (%)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;contrast_error (%)&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Go over labels and collect the parameters</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Search for the fit parameters in the legend label</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="c1"># Extract the fit parameters and their uncertainties</span>
            <span class="n">sigma</span><span class="p">,</span> <span class="n">sigma_err</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">mu_err</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">C</span><span class="p">,</span> <span class="n">C_err</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

            <span class="c1"># Fill the dataframe</span>
            <span class="n">params_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Peak at </span><span class="si">{</span><span class="n">mu</span><span class="si">}</span><span class="s2"> ps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">mu</span><span class="p">,</span>
                <span class="n">mu_err</span><span class="p">,</span>
                <span class="n">sigma</span><span class="p">,</span>
                <span class="n">sigma_err</span><span class="p">,</span>
                <span class="n">C</span><span class="p">,</span>
                <span class="n">C_err</span><span class="p">,</span>
            <span class="p">]</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">,</span> <span class="n">params_df</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Sergei Kulkov.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>